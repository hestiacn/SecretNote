<?php
// å¯ç”¨ä¸¥æ ¼é”™è¯¯æŠ¥å‘Š
declare(strict_types=1);
error_reporting(E_ALL);
ini_set('display_errors', '1');

require_once __DIR__.'/include/Parsedown.php';

// å®‰å…¨å¤´è®¾ç½®
header("X-Frame-Options: DENY");
header("X-XSS-Protection: 1; mode=block");
header("X-Content-Type-Options: nosniff");
header("Content-Security-Policy: default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.tiny.cloud");
header("Referrer-Policy: strict-origin-when-cross-origin");
define('IP_API', 'https://cn.apihz.cn/api/ip/chaapi.php?id=10002193&key=7e1f5d0b23db5803520f39f63c917368&ip=');

// ä¼šè¯ç®¡ç†
if (session_status() === PHP_SESSION_NONE) {
    session_start([
        'cookie_secure' => isset($_SERVER['HTTPS']),
        'cookie_httponly' => true,
        'cookie_samesite' => 'Strict'
    ]);
}

// å®‰å…¨å‡½æ•°
function sanitizeInput(string $input): string {
    return htmlspecialchars(strip_tags(trim($input)), ENT_QUOTES, 'UTF-8');
}

function generateCSRFToken(): string {
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

function validateCSRFToken(string $token): bool {
    return hash_equals($_SESSION['csrf_token'] ?? '', $token);
}

// å…è®¸çš„HTMLæ ‡ç­¾ç™½åå•ï¼ˆç”¨äºå¯Œæ–‡æœ¬è¿‡æ»¤ï¼‰
function sanitizeHTML(string $input): string {
    require_once __DIR__.'/assets/htmlpurifier/library/HTMLPurifier.auto.php';
    
    $config = HTMLPurifier_Config::createDefault();
    
    // 1. åŸºç¡€é…ç½®
    $allowed_tags = 'p,strong,em,u,h1,h2,h3,h4,h5,h6,img,a,div,span,br,hr,ul,ol,li,blockquote,pre,code,video';
    $config->set('HTML.Allowed', $allowed_tags);

    // 2. ç¼“å­˜é…ç½®ï¼ˆå…ˆäºHTMLå®šä¹‰ï¼‰
    $cacheDir = __DIR__.'/cache/htmlpurifier/';
    if (!file_exists($cacheDir)) mkdir($cacheDir, 0755, true);
    $config->set('Cache.SerializerPath', $cacheDir);

    // 3. HTMLå®šä¹‰é…ç½®
    $config->set('HTML.DefinitionID', 'custom-attributes-v2'); // æ›´æ–°ç‰ˆæœ¬å·
    $config->set('HTML.DefinitionRev', 2); // æ›´æ–°ä¿®è®¢å·

    if ($def = $config->maybeGetRawHTMLDefinition()) {
        $def->addAttribute('img', 'data-type', 'Text');
        $def->addAttribute('a', 'rel', 'Enum#nofollow');
        $def->addElement('video', 'Block', 'Flow', 'Common', [
            'src' => 'URI',
            'width' => 'Length',
            'height' => 'Length',
            'controls' => 'Bool',
            'preload' => 'Enum#auto,metadata,none'
        ]);
    }

    // 4. å±æ€§ç™½åå•ï¼ˆåœ¨å®šä¹‰ä¹‹åè®¾ç½®ï¼‰
    $config->set('HTML.AllowedAttributes', [
        'img.src' => true,
        // ...å…¶ä»–å±æ€§é…ç½®
    ]);

    // 5. æœ€ååˆ›å»ºå®ä¾‹
    $purifier = new HTMLPurifier($config);
    
    return $purifier->purify(trim($input));
}

// å®æ—¶Markdowné¢„è§ˆåŠŸèƒ½
function parsedown(string $text): string {
    static $parser = null;
    if (!$parser) {
        $parser = new Parsedown();
        $parser->setSafeMode(true);
    }
    return $parser->text($text);
}

// æ•°æ®åº“é…ç½®
define('CONFIG_FILE', __DIR__ . '/include/config.php'); 

if (!file_exists(CONFIG_FILE)) {
    die(json_encode(['success' => false, 'message' => 'é…ç½®æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥å®‰è£…ï¼']));
}
require_once(CONFIG_FILE);

// éªŒè¯å¸¸é‡æ˜¯å¦å®šä¹‰
$requiredConstants = ['DB_HOST', 'DB_USER', 'DB_PASS', 'DB_NAME'];
foreach ($requiredConstants as $constant) {
    if (!defined($constant)) {
        die(json_encode(['success' => false, 'message' => "é…ç½®é”™è¯¯ï¼šå¸¸é‡ $constant æœªå®šä¹‰ï¼"]));
    }
}

// æ•°æ®åº“è¿æ¥ï¼ˆå¢åŠ é”™è¯¯å¤„ç†ï¼‰
try {
    $mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);
    if ($mysqli->connect_errno) {
        throw new RuntimeException("æ•°æ®åº“è¿æ¥å¤±è´¥: ".$mysqli->connect_error);
    }
    $mysqli->set_charset('utf8mb4');
} catch (Exception $e) {
    die(json_encode(['success' => false, 'message' => 'æ•°æ®åº“é”™è¯¯ï¼š' . $e->getMessage()]));
}

// åˆå§‹åŒ–å˜é‡
$tablePrefix = DB_PREFIX;
$csrfToken = generateCSRFToken();
$error = null;
$success = null;

// åœ¨æ•°æ®åº“è¿æ¥åæ·»åŠ åˆ†ç±»æŸ¥è¯¢
$categories = $mysqli->query("SELECT * FROM {$tablePrefix}typeid ORDER BY id")->fetch_all(MYSQLI_ASSOC);

// å¤„ç†è¡¨å•æäº¤
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    header('Content-Type: application/json'); // è®¾ç½®å“åº”å¤´ä¸º JSON

    if (!validateCSRFToken($_POST['csrf_token'] ?? '')) {
        echo json_encode(['success' => false, 'message' => 'CSRFä»¤ç‰ŒéªŒè¯å¤±è´¥']);
        exit;
    }

    // å­—æ®µåˆå§‹åŒ–
    $ip = filter_var($_SERVER['HTTP_X_FORWARDED_FOR'] ?? $_SERVER['REMOTE_ADDR'] ?? '', FILTER_VALIDATE_IP) ?: 'æ— æ•ˆIP';
    $thetitle = sanitizeInput($_POST['thetitle'] ?? '');
    $nicheng = sanitizeInput($_POST['nicheng'] ?? '');
    $image = sanitizeInput($_POST['avatar'] ?? 'touxiang/default3/1.gif');
    $content = sanitizeHTML($_POST['content'] ?? '');
    $qiaoqiao = isset($_POST['qiaoqiao']) ? 1 : 0;
    $qiaoqiaopass = $_POST['qiaoqiaopass'] ?? '';
    $typeid = (int)($_POST['typeid'] ?? 0);
    $editor_type = sanitizeInput($_POST['editor_type'] ?? 'markdown');
    $content_md = '';
    $content_html = '';
    $media_type = $_POST['media_type'] ?? 'none';
    $local_image = '';
    $external_video = '';

    // éªŒè¯é€»è¾‘
    $requiredFields = ['thetitle' => 'æ ‡é¢˜', 'nicheng' => 'æ˜µç§°', 'content' => 'å†…å®¹'];
    foreach ($requiredFields as $field => $name) {
        if (empty($_POST[$field] ?? '')) {
            echo json_encode(['success' => false, 'message' => "{$name}ä¸èƒ½ä¸ºç©º"]);
            exit;
        }
    }

	$content_md = '';
	$content_html = '';
	
	if ($editor_type === 'markdown') {
	    // ä»éšè—åŸŸè·å–åŸå§‹Markdownå†…å®¹
	    $content_md = trim($_POST['content'] ?? '');
	    $content_html = parsedown($content_md);
	    $content = sanitizeHTML($content_html); 
	} else {
	    // ç›´æ¥å¤„ç†å¯Œæ–‡æœ¬å†…å®¹
	    $raw_content = $_POST['content'] ?? '';
	    $content = sanitizeHTML($raw_content);
	    $content_html = $content; // å…¼å®¹æ˜¾ç¤ºå±‚
	}
    // åœ¨è¡¨å•å¤„ç†éƒ¨åˆ†å¢åŠ åª’ä½“å¤„ç†
    if ($media_type === 'image') {
        $local_image = sanitizeInput($_POST['local_image']);
    } elseif ($media_type === 'video') {
        if (!empty($_POST['local_image'])) {
            $local_image = sanitizeInput($_POST['local_image']);
        } else {
            $external_video = sanitizeInput($_POST['external_video']);
        }
    }

    // IP åœ°å€å¤„ç†
    $ip = filter_var($_SERVER['HTTP_X_FORWARDED_FOR'] ?? $_SERVER['REMOTE_ADDR'] ?? '', FILTER_VALIDATE_IP) ?: '';
    $location = 'æœªçŸ¥åœ°åŒº';
    if ($ip) {
        require_once __DIR__.'/include/ip.php';
        $location = getIPLocation($ip);
    }

    // è¿ç¦è¯æ£€æµ‹æ¨¡å—
    define('BANNED_WORDS_FILE', __DIR__.'/words.b64');
    define('CACHE_DIR', __DIR__.'/cache');
    define('REGEX_CACHE', CACHE_DIR.'/regex_cache.dat');

    if (!file_exists(CACHE_DIR)) {
        mkdir(CACHE_DIR, 0755, true);
    }

    // åŠ è½½è¿ç¦è¯åº“
    function loadBannedWords() {
        if (!file_exists(BANNED_WORDS_FILE)) return [];
        $content = base64_decode(file_get_contents(BANNED_WORDS_FILE));
        return array_filter(explode("\n", $content), function($word) {
            $word = trim($word);
            return !empty($word) && $word[0] !== '#';
        });
    }

    // æ™ºèƒ½æ­£åˆ™ç”Ÿæˆå™¨
function buildSmartRegex($words) {
    if (!is_array($words)) {
        error_log("Invalid input for buildSmartRegex: " . json_encode($words));
        return [];
    }

    $chunks = array_chunk($words, 50);
    $patterns = [];
    foreach ($chunks as $chunk) {
        $escaped = array_map(function($word) {
            if (!is_string($word) || trim($word) === '') {
                return ''; // å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²æˆ–ä¸ºç©ºï¼Œç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²
            }
            // ç¡®ä¿ç¼–ç ä¸º UTF-8
            $word = mb_convert_encoding($word, 'UTF-8', 'auto');
            if ($word === false) {
                return ''; // å¦‚æœç¼–ç è½¬æ¢å¤±è´¥ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
            }
            // å»é™¤æ§åˆ¶å­—ç¬¦
            $word = preg_replace('/\p{C}+/u', '', $word);
            if (preg_match('/\p{Han}/u', $word)) {
                return '(?<!\pL)' . preg_quote($word, '/') . '(?!\pL)';
            }
            return '\b' . preg_quote($word, '/') . '\b';
        }, $chunk);
        $escaped = array_filter($escaped, function($item) {
            return !empty($item);
        });
        if (!empty($escaped)) {
            $patterns[] = '/' . implode('|', $escaped) . '/iu';
        }
    }
    return $patterns;
}

    // å¸¦è°ƒè¯•çš„è¿ç¦è¯æ£€æµ‹
    function detectBannedWords($text, $patterns) {
        $cleanText = preg_replace('/[^\p{Han}a-zA-Z0-9]/u', '', $text);
        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $cleanText, $matches)) {
                error_log("[è¿ç¦è¯å‘Šè­¦] åŒ¹é…è§„åˆ™: $pattern");
                error_log("[è¿ç¦è¯å‘Šè­¦] å‘½ä¸­å†…å®¹: ".$matches[0]);
                return true;
            }
        }
        return false;
    }

    // ä¸»æ‰§è¡Œæµç¨‹
    $bannedWords = loadBannedWords();
    if (file_exists(REGEX_CACHE) && (time()-filemtime(REGEX_CACHE)) < 3600) {
        $patterns = unserialize(file_get_contents(REGEX_CACHE));
    } else {
        $patterns = buildSmartRegex($bannedWords);
        file_put_contents(REGEX_CACHE, serialize($patterns));
        error_log("[ç³»ç»Ÿé€šçŸ¥] å·²é‡å»ºè¿ç¦è¯æ­£åˆ™ç¼“å­˜ï¼Œå…±".count($patterns)."ç»„æ¨¡å¼");
    }

    // æ‰§è¡Œæ£€æµ‹
    if (!$error && !empty($patterns)) {
        $checkText = $thetitle . ' ' . $content;
        if (detectBannedWords($checkText, $patterns)) {
            echo json_encode(['success' => false, 'message' => 'å†…å®¹åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·è°ƒæ•´åé‡æ–°æäº¤']);
            exit;
        }
    }
	// åœ¨ç›¸ä¼¼åº¦æ£€æµ‹ä¹‹å‰æ·»åŠ é‡å¤å†…å®¹æ£€æŸ¥
	$stmt = $mysqli->prepare("SELECT COUNT(*) FROM {$tablePrefix}book WHERE content = ? AND time > NOW() - INTERVAL 1 DAY");
	$stmt->bind_param('s', $content);
	$stmt->execute();
	$count = $stmt->get_result()->fetch_row()[0];
	if ($count > 0) {
	    echo json_encode(['success' => false, 'message' => 'è¯·å‹¿é‡å¤æäº¤ç›¸åŒå†…å®¹']);
	    exit;
	}
    // ç›¸ä¼¼åº¦æ£€æµ‹
    if (!$error) {
        $similarThreshold = 75;
        $checkHours = 24;
        $stmt = $mysqli->prepare("SELECT content FROM {$tablePrefix}book WHERE time > NOW() - INTERVAL ? HOUR ORDER BY id DESC LIMIT 100");
        $stmt->bind_param('i', $checkHours);
        $stmt->execute();
        $result = $stmt->get_result();

        $inputContent = preg_replace('/[^\p{Han}a-z0-9]/u', '', $content);
        $inputLength = mb_strlen($inputContent);

        while ($row = $result->fetch_assoc()) {
            $dbContent = preg_replace('/[^\p{Han}a-z0-9]/u', '', $row['content']);
            $dbLength = mb_strlen($dbContent);

            if ($inputLength > 0 && abs($inputLength - $dbLength)/$inputLength > 0.3) {
                continue;
            }

            similar_text($inputContent, $dbContent, $percent);
            if ($percent >= $similarThreshold) {
                echo json_encode(['success' => false, 'message' => "å†…å®¹ç›¸ä¼¼åº¦è¿‡é«˜ï¼ˆç›¸ä¼¼åº¦".round($percent,1)."%ï¼‰ï¼Œè¯·ä¿®æ”¹åé‡è¯•"]);
                exit;
            }
        }
    }

    // æäº¤é¢‘ç‡é™åˆ¶
    if (!$error) {
        $stmt = $mysqli->prepare("SELECT COUNT(*) FROM {$tablePrefix}book WHERE ip = ? AND time > NOW() - INTERVAL 1 HOUR");
        $stmt->bind_param('s', $ip);
        $stmt->execute();
        $count = $stmt->get_result()->fetch_row()[0];
        if ($count >= 5) {
            echo json_encode(['success' => false, 'message' => 'æäº¤è¿‡äºé¢‘ç¹ï¼Œè¯·1å°æ—¶åå†è¯•']);
            exit;
        }
    }

    // éªŒè¯ç éªŒè¯
    if (!$error) {
        $captcha = $_POST['captcha'] ?? '';
        if (empty($captcha)) {
            echo json_encode(['success' => false, 'message' => 'éªŒè¯ç ä¸èƒ½ä¸ºç©º']);
            exit;
        } elseif (!isset($_SESSION['captcha']) || strtoupper($captcha) !== strtoupper($_SESSION['captcha'])) {
            echo json_encode(['success' => false, 'message' => 'éªŒè¯ç ä¸æ­£ç¡®']);
            exit;
        }
    }

    // æ‚„æ‚„è¯å¯†ç éªŒè¯
    if (!$error && $qiaoqiao && empty($qiaoqiaopass)) {
        echo json_encode(['success' => false, 'message' => 'å¼€å¯æ‚„æ‚„è¯å¿…é¡»è®¾ç½®å¯†ç ']);
        exit;
    }

    // æ•°æ®åº“æ“ä½œ
    if (!$error) {
        $qiaoqiaopass = $qiaoqiao ? password_hash($qiaoqiaopass, PASSWORD_DEFAULT) : '';
        $allow_html = (int)($_POST['allow_html'] ?? 0); 
		$stmt = $mysqli->prepare("INSERT INTO {$tablePrefix}book (
		    thetitle, nicheng, content, content_md, content_html, editor_type, shenhe, ip, ipshiji, 
		    qiaoqiao, qiaoqiaopass, media_type, local_image, external_video, allow_html
		) VALUES (?, ?, ?, ?, ?, ?, 1, ?, ?, ?, ?, ?, ?, ?, ?)");
		
		// ç¡®ä¿ç±»å‹å®šä¹‰å­—ç¬¦ä¸²å’Œç»‘å®šå˜é‡æ•°é‡ä¸€è‡´
		$stmt->bind_param('ssssssssissssi',
		    $thetitle,
		    $nicheng,
		    $content,
		    $content_md,
		    $content_html,
		    $editor_type,
		    $ip,
		    $location,
		    $qiaoqiao,
		    $qiaoqiaopass,
		    $media_type,
		    $local_image,
		    $external_video,
		    $allow_html
		);

        if ($stmt->execute()) {
            echo json_encode(['success' => true, 'message' => 'ç•™è¨€æ·»åŠ æˆåŠŸ']);
        } else {
            echo json_encode(['success' => false, 'message' => 'æ•°æ®åº“é”™è¯¯: ' . $stmt->error]);
        }
    }
    exit;
}
?>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“å®çŸ³ç•™è¨€æœ¬ - å‘å¸ƒåŒ¿åç•™è¨€</title>
    <link href="../assets/bootstrap-5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/bootstrap-icons-1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* æ–°å¢ç¼–è¾‘å™¨ç›¸å…³æ ·å¼ */
        .editor-toolbar {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }
        .toolbar-btn {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .toolbar-btn:hover {
            background-color: #e9ecef;
            border-color: #0d6efd;
            color: #0d6efd;
        }
        .emoji-panel {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            max-width: 300px;
        }
        .emoji-item {
            cursor: pointer;
            font-size: 20px;
            padding: 3px;
            text-align: center;
        }
        .image-upload-wrapper {
            position: relative;
            display: inline-block;
        }
        #imageInput {
            display: none;
        }
        #editor-container {
            min-height: 300px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 0 0 4px 4px;
            overflow-y: auto;
            outline: none;
        }
        .avatar-selector {
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin: 15px 0;
        }
        .avatar-option {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 5px;
            padding: 2px;
        }
        .avatar-option.selected {
            border-color: #0d6efd;
		  width: 60px; 
		  height: 60px; 
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        .header {
            background-color: #0d6efd;
            color: white;
            padding: 2rem;
            border-radius: 0 0 1rem 1rem;
        }  
        /* å¢åŠ ç¼–è¾‘å™¨æ¨¡å¼åˆ‡æ¢æ ·å¼ */
		.editor-mode-btn.active {
		    background-color: #0d6efd;
		    color: white !important;
		}
		.markdown-container textarea {
		    font-size: 14px;
		    line-height: 1.6;
		    tab-size: 4;
		}
		.preview-area {
		    background: #f8f9fa;
		    border-radius: 4px;
		}
		.preview-area h1, .preview-area h2 {
		    border-bottom: 1px solid #eee;
		    padding-bottom: 0.3em;
		}
		/* æ–°å¢æ ·å¼ */
		#html-mode-toggle.active {
		    background-color: #dc3545;
		    color: white !important;
		    animation: pulse 1.5s infinite;
		}
		
		@keyframes pulse {
		    0% { box-shadow: 0 0 0 0 rgba(220,53,69,.5); }
		    70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); }
		    100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); }
		}
		
		.uploaded-media {
		    max-width: 300px;
		    border: 2px dashed #0d6efd;
		    margin: 10px 0;
		}
		
		#mediaModal .modal-body {
		    background: #f8f9fa;
		    border-radius: 8px;
		}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="display-5 fw-bold mb-3">å‘å¸ƒåŒ¿åç•™è¨€</h1>
        </div>

        <div class="content p-4">
	    <!-- æ–°å¢æ¶ˆæ¯æç¤º -->
	    <?php if ($error): ?>
	    <div class="alert alert-danger alert-dismissible fade show" role="alert">
	        <?= htmlspecialchars($error) ?>
	        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	    </div>
	    <?php endif; ?>
	
	    <?php if ($success): ?>
	    <div class="alert alert-success alert-dismissible fade show" role="alert">
	        <?= htmlspecialchars($success) ?>
	        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	    </div>
	    <?php endif; ?>
            <form method="post">
                <!-- å¤´åƒé€‰æ‹© -->
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©å¤´åƒ</label>
                    <div class="avatar-selector">
                        <?php
                        $avatars = array_map(fn($n) => "assets/touxiang/default3/{$n}.gif", range(1, 24));
                        foreach ($avatars as $avatar):
                        ?>
                        <label class="avatar-option">
                            <input type="radio" name="avatar" value="<?= htmlspecialchars($avatar) ?>" 
                                   <?= $avatar === 'touxiang/default3/1.gif' ? 'checked' : '' ?> hidden>
                            <img src="../<?= htmlspecialchars($avatar) ?>" 
                                 class="img-thumbnail" 
                                 width="60" 
                                 alt="å¤´åƒ <?= $avatar ?>">
                        </label>
                        <?php endforeach; ?>
                    </div>
                </div>
                <!-- åˆ†ç±»é€‰æ‹© -->
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©åˆ†ç±»</label>
                    <select class="form-select" name="typeid">
                        <option value="0">-- æ— åˆ†ç±» --</option>
                        <?php foreach ($categories as $cat): ?>
                        <option value="<?= $cat['id'] ?>"><?= htmlspecialchars($cat['typename']) ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <!-- è¡¨å•å­—æ®µ -->
                <input type="hidden" name="csrf_token" value="<?= htmlspecialchars($csrfToken ?? '') ?>">
			<?php
			$fields = [
			    'thetitle' => ['label' => 'æ ‡é¢˜', 'type' => 'text'],
			    'nicheng' => ['label' => 'æ˜µç§°ï¼ˆé»˜è®¤åŒ¿åï¼‰', 'type' => 'text']
			];
			foreach ($fields as $name => $config): ?>
			<div class="mb-3">
			    <label class="form-label"><?= htmlspecialchars($config['label']) ?></label>
			    <input type="<?= htmlspecialchars($config['type']) ?>" 
			           class="form-control" 
			           name="<?= htmlspecialchars($name) ?>"
			           value="<?= $name === 'nicheng' ? 'åŒ¿åç•™è¨€' : '' ?>"
			           <?= $name === 'thetitle' ? 'required' : '' ?>>
			</div>
			<?php endforeach; ?>

                <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
                <div class="mb-3">
                    <label class="form-label">å†…å®¹</label>
                    <div class="border rounded">
                        <div class="editor-toolbar">

                            <button type="button" class="toolbar-btn" data-command="bold" title="åŠ ç²—">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="toolbar-btn" data-command="italic" title="æ–œä½“">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="toolbar-btn" data-command="underline" title="ä¸‹åˆ’çº¿">
                                <i class="bi bi-type-underline"></i>
                            </button>
                            <div class="image-upload-wrapper">
                                <button type="button" class="toolbar-btn" title="æ’å…¥å›¾ç‰‡">
                                    <i class="bi bi-image"></i>
                                    <input type="file" id="imageInput" accept="image/*">
                                </button>
                            </div>
                            <div class="position-relative">
                                <button type="button" class="toolbar-btn" title="æ’å…¥è¡¨æƒ…">
                                    <i class="bi bi-emoji-smile"></i>
                                </button>
                                <div class="emoji-panel">
                                    <?php
                                    $emojis = ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£',
                                              'â¤ï¸','ğŸ‘','ğŸ‰','ğŸš€','ğŸ˜Š','ğŸ˜','ğŸ¥³','ğŸ¤©'];
                                    foreach ($emojis as $emoji): ?>
                                    <span class="emoji-item" data-emoji="<?= $emoji ?>"><?= $emoji ?></span>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                            <div class="btn-group">
				        <button type="button" class="toolbar-btn editor-mode-btn active" data-mode="markdown">
				            <i class="bi bi-markdown"></i> MD
				        </button>
				        <button type="button" class="toolbar-btn editor-mode-btn" data-mode="rich-text">
				            <i class="bi bi-code-square"></i> HTML
				        </button>
				        </div>
				        <div class="btn-group">
					    <!-- è§†é¢‘æ’å…¥æŒ‰é’® -->
					    <button type="button" class="toolbar-btn" id="insert-video" title="æ’å…¥è§†é¢‘">
					        <i class="bi bi-camera-reels"></i>
					    </button>
					    
					    <!-- HTMLæ¨¡å¼å¼€å…³ -->
					    <button type="button" class="toolbar-btn" id="html-mode-toggle" title="HTMLæ¨¡å¼">
					        <i class="bi bi-code-slash"></i>
					    </button>
						</div>
                           </div>
                           <!-- åª’ä½“æ’å…¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="mediaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ’å…¥åª’ä½“</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">åª’ä½“ç±»å‹</label>
                    <select class="form-select" id="mediaSource">
                        <option value="local">æœ¬åœ°ä¸Šä¼ </option>
                        <option value="external">å¤–éƒ¨é“¾æ¥</option>
                    </select>
                </div>
                <div id="mediaInputContainer">
                    <input type="file" class="form-control" accept="image/*,video/*" id="mediaFile">
                    <input type="url" class="form-control d-none" placeholder="https://" id="mediaUrl">
                </div>
                <div class="form-text mt-2">
                    æ”¯æŒæ ¼å¼ï¼šJPEG/PNG/MP4ï¼Œæœ€å¤§10MB
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmMedia">æ’å…¥</button>
            </div>
        </div>
    </div>
</div>
                        <!-- å¢åŠ Markdownç¼–è¾‘å™¨å®¹å™¨ -->
					<div id="markdown-container" class="d-none">
					    <textarea id="markdown-editor" class="form-control" 
					              placeholder="ä½¿ç”¨Markdownè¯­æ³•ä¹¦å†™..." 
					              style="height:300px; font-family: monospace;"></textarea>
					    <div class="mt-2">
					        <button type="button" class="btn btn-sm btn-outline-secondary preview-btn">
					            <i class="bi bi-eye"></i> é¢„è§ˆ
					        </button>
					    </div>
					    <div class="preview-area border p-3 mt-2 d-none"></div>
					</div>
					<div id="rich-editor-container" class="border rounded">
                        <div id="editor-container" 
                             contenteditable="true" 
                             data-placeholder="è¯·è¾“å…¥å†…å®¹..."
                             class="p-3"></div>
                    </div>
                    <textarea name="content" id="hidden-content" hidden></textarea>
                </div>
				<!-- æ–°å¢å­—ç¬¦æ•°æç¤º -->
				<div class="mt-2 text-end text-muted small">
				    å½“å‰å­—ç¬¦æ•°ï¼š<span id="char-counter">0</span>/æœ€ä½10å­—
				</div>
                <!-- æ‚„æ‚„è¯è®¾ç½® -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               name="qiaoqiao" 
                               id="qiaoqiao">
                        <label class="form-check-label" for="qiaoqiao">å¯ç”¨æ‚„æ‚„è¯</label>
                    </div>
                    <input type="password" 
                           class="form-control mt-2" 
                           name="qiaoqiaopass" 
                           id="qiaoqiaopass" 
                           placeholder="è®¾ç½®æŸ¥çœ‹å¯†ç "
                           disabled
                           required>
                </div>

                <!-- éªŒè¯ç  -->
			<div class="mb-3 row align-items-center">
			    <div class="col-md-4">
			        <input type="text" 
			               class="form-control"
			               name="captcha"
			               placeholder="è¾“å…¥éªŒè¯ç "
			               required>
			    </div>
				<div class="col-md-4 mt-2 mt-md-0">
				    <img src="../include/captcha.php" 
				         alt="éªŒè¯ç " 
				         class="img-thumbnail"
				         onclick="this.src='../include/captcha.php?'+Date.now()"
				         id="captchaImg"
				         style="cursor: pointer; height: 40px;">
				</div>
			</div>

                <button type="submit" class="btn btn-primary w-100 py-2">
                    <i class="bi bi-send-check me-2"></i>æäº¤ç•™è¨€
                </button>
            </form>
        </div>
    </div>
    
    <input type="hidden" name="media_type" id="mediaType" value="none">
<input type="hidden" name="local_image" id="localImage">
<input type="hidden" name="external_video" id="externalVideo">
<input type="hidden" name="allow_html" id="allowHtml" value="0">
<script src="../assets/bootstrap-5.3.3/js/marked.min.js"></script>
    <script>
// æ›´æ–°ç¼–è¾‘å™¨äº¤äº’è„šæœ¬
let currentMode = 'markdown';

// æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
document.querySelectorAll('.editor-mode-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.editor-mode-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentMode = this.dataset.mode;
        
        document.getElementById('markdown-container').classList.toggle('d-none', currentMode !== 'markdown');
        document.getElementById('rich-editor-container').classList.toggle('d-none', currentMode === 'markdown');
        
        if(currentMode === 'markdown') {
            document.getElementById('markdown-editor').value = hiddenContent.value;
        } else {
            hiddenContent.value = editor.innerHTML;
        }
    });
});

// Markdowné¢„è§ˆåŠŸèƒ½
document.querySelector('.preview-btn').addEventListener('click', function() {
    const previewArea = document.querySelector('.preview-area');
    previewArea.innerHTML = marked.parse(document.getElementById('markdown-editor').value);
    previewArea.classList.toggle('d-none');
});

// æ›´æ–°è¡¨å•æäº¤å¤„ç†
document.querySelector('form').addEventListener('submit', function(e) {
    if(currentMode === 'markdown') {
        hiddenContent.value = document.getElementById('markdown-editor').value;
    }
    
    const formData = new FormData(this);
    formData.append('editor_type', currentMode);
    
    // é˜»æ­¢é»˜è®¤æäº¤ï¼Œæ”¹ä¸ºAJAXå‘é€
    e.preventDefault();
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    }).then(/* å¤„ç†å“åº” */);
});
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('editor-container');
        const hiddenContent = document.getElementById('hidden-content');
        let isEmojiPanelOpen = false;

        // åŒæ­¥å†…å®¹åˆ°éšè—åŸŸ
        function syncContent() {
            hiddenContent.value = editor.innerHTML;
        }

        // åŸºç¡€æ ¼å¼åŠŸèƒ½
        document.querySelectorAll('[data-command]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.execCommand(this.dataset.command, false, null);
                editor.focus();
                syncContent();
            });
        });

        // EmojiåŠŸèƒ½
        document.querySelectorAll('.emoji-item').forEach(item => {
            item.addEventListener('click', function() {
                const emoji = this.dataset.emoji;
                document.execCommand('insertText', false, emoji);
                syncContent();
            });
        });

        // æ˜¾ç¤º/éšè—Emojié¢æ¿
        document.querySelector('[title="æ’å…¥è¡¨æƒ…"]').addEventListener('click', function(e) {
            const panel = this.nextElementSibling;
            panel.style.display = panel.style.display === 'grid' ? 'none' : 'grid';
            e.stopPropagation();
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­Emojié¢æ¿
        document.addEventListener('click', () => {
            document.querySelector('.emoji-panel').style.display = 'none';
        });

        // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        document.getElementById('imageInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶
            if (!file.type.startsWith('image/')) {
                alert('ä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶');
                return;
            }
            if (file.size > 2 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                return;
            }

            // æ’å…¥ä¸´æ—¶é¢„è§ˆ
            const tempUrl = URL.createObjectURL(file);
            const tempImg = document.createElement('img');
            tempImg.src = tempUrl;
            tempImg.style.maxWidth = '200px';
            tempImg.classList.add('uploading');
            document.execCommand('insertHTML', false, tempImg.outerHTML);
            
            // ä¸Šä¼ æ–‡ä»¶
            const formData = new FormData();
            formData.append('file', file);
            formData.append('csrf_token', '<?= $csrfToken ?>');

            try {
                const response = await fetch('../include/upload.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.errno !== 0) throw new Error(result.message);

                // æ›¿æ¢ä¸´æ—¶å›¾ç‰‡
                const newImg = `<img src="${result.data.url}" style="max-width:100%" alt="ç”¨æˆ·ä¸Šä¼ ">`;
                editor.innerHTML = editor.innerHTML.replace(tempUrl, newImg);
                syncContent();
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                tempImg.remove();
            } finally {
                URL.revokeObjectURL(tempUrl);
            }
        });
// æ–°å¢å®æ—¶å­—ç¬¦è®¡æ•°åŠŸèƒ½ ---------------------
function updateCharCount() {
    let contentLength = 0;

    if (currentMode === 'markdown') {
        contentLength = document.getElementById('markdown-editor').value.trim().length;
    } else {
        contentLength = document.getElementById('editor-container').textContent.trim().length;
    }

    document.getElementById('char-counter').textContent = contentLength;
}

// ç›‘å¬è¾“å…¥äº‹ä»¶
document.getElementById('markdown-editor').addEventListener('input', updateCharCount);
document.getElementById('editor-container').addEventListener('input', updateCharCount);

// åˆå§‹åŒ–è®¡æ•°
updateCharCount();
// ç»“æŸæ–°å¢ ---------------------------
        // è‡ªåŠ¨ä¿å­˜å†…å®¹
		// editor.addEventListener('input', syncContent);
		
		// ä¿®æ”¹åï¼ˆå¢åŠ å®æ—¶åŒæ­¥ï¼‰
		function syncContent() {
		    if(currentMode === 'markdown') {
		        document.getElementById('hidden-content').value = document.getElementById('markdown-editor').value;
		    } else {
		        document.getElementById('hidden-content').value = editor.innerHTML;
		    }
		}
		
		// å¢åŠ å®šæ—¶åŒæ­¥ï¼ˆæ¯2ç§’ï¼‰
		setInterval(syncContent, 2000);
        editor.addEventListener('paste', syncContent);

        // å¤´åƒé€‰æ‹©åŠŸèƒ½
        document.querySelectorAll('.avatar-option').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.avatar-option').forEach(el => {
                    el.classList.remove('selected');
                });
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });

        // æ‚„æ‚„è¯åŠŸèƒ½
        document.getElementById('qiaoqiao').addEventListener('change', function() {
            const passInput = document.getElementById('qiaoqiaopass');
            passInput.disabled = !this.checked;
            passInput.required = this.checked;
            if (!this.checked) passInput.value = '';
        });

        // è¡¨å•æäº¤éªŒè¯
        document.querySelector('form').addEventListener('submit', function(e) {
            // å†…å®¹é•¿åº¦éªŒè¯
            if (editor.textContent.trim().length < 10) {
                alert('å†…å®¹ä¸èƒ½å°‘äº10ä¸ªå­—ç¬¦');
                e.preventDefault();
                return;
            }

            // å¯†ç éªŒè¯
            if (document.getElementById('qiaoqiao').checked && 
                document.getElementById('qiaoqiaopass').value.length < 6) {
                alert('æŸ¥çœ‹å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
                e.preventDefault();
            }
            
		    if (éªŒè¯å¤±è´¥) {
		        document.getElementById('captchaImg').src = '../include/captcha.php?' + Date.now();
		        e.preventDefault();
		    }
        });
    });
// åœ¨è¡¨å•æäº¤éªŒè¯éƒ¨åˆ†å¢åŠ å­—ç¬¦æ•°æ£€æµ‹é€»è¾‘ï¼ˆçº¦åœ¨ line 880-900ï¼‰
document.querySelector('form').addEventListener('submit', function(e) {
    let contentLength = 0;

    if (currentMode === 'markdown') {
        contentLength = document.getElementById('markdown-editor').value.trim().length;
    } else {
        // ä½¿ç”¨ innerText è·å–çº¯æ–‡æœ¬å†…å®¹
        contentLength = document.getElementById('editor-container').innerText.trim().length;
    }

    // å†…å®¹é•¿åº¦éªŒè¯ï¼ˆæœ€å°‘10å­—ç¬¦ï¼‰
    if (contentLength < 10) {
        alert('å†…å®¹ä¸èƒ½å°‘äº10ä¸ªå­—ç¬¦');
        e.preventDefault();
        return;
    }

    // æ‚„æ‚„è¯å¯†ç éªŒè¯
    if (document.getElementById('qiaoqiao').checked && 
        document.getElementById('qiaoqiaopass').value.length < 6) {
        alert('æŸ¥çœ‹å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
        e.preventDefault();
        return;
    }
});
    // è§†é¢‘æ’å…¥å¤„ç†
document.getElementById('insert-video').addEventListener('click', () => {
    new bootstrap.Modal(document.getElementById('mediaModal')).show();
});

// åª’ä½“ç±»å‹åˆ‡æ¢
document.getElementById('mediaSource').addEventListener('change', function() {
    const isLocal = this.value === 'local';
    document.getElementById('mediaFile').classList.toggle('d-none', !isLocal);
    document.getElementById('mediaUrl').classList.toggle('d-none', isLocal);
});

// åª’ä½“æ’å…¥ç¡®è®¤
document.getElementById('confirmMedia').addEventListener('click', async function() {
    const isLocal = document.getElementById('mediaSource').value === 'local';
    let mediaValue = '';

    if (isLocal) {
        const file = document.getElementById('mediaFile').files[0];
        if (!file) return;
        
        // éªŒè¯æ–‡ä»¶
        const validTypes = ['image/jpeg', 'image/png', 'video/mp4'];
        if (!validTypes.includes(file.type)) {
            alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
            return;
        }
        if (file.size > 10 * 1024 * 1024) {
            alert('æ–‡ä»¶å¤§å°è¶…è¿‡10MBé™åˆ¶');
            return;
        }

        // ä¸Šä¼ å¤„ç†
        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrf_token', '<?= $csrfToken ?>');

        try {
            const response = await fetch('../include/upload.php', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            mediaValue = result.url;
            
            // æ›´æ–°éšè—åŸŸ
            document.getElementById('mediaType').value = file.type.startsWith('video') ? 'video' : 'image';
            document.getElementById('localImage').value = mediaValue;
        } catch (error) {
            alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            return;
        }
    } else {
        mediaValue = document.getElementById('mediaUrl').value;
        if (!mediaValue) return;
        
        // éªŒè¯URL
        try {
            new URL(mediaValue);
        } catch {
            alert('æ— æ•ˆçš„URLåœ°å€');
            return;
        }

        // æ›´æ–°éšè—åŸŸ
        document.getElementById('mediaType').value = 'video';
        document.getElementById('externalVideo').value = mediaValue;
    }

    // æ’å…¥å†…å®¹
    if (currentMode === 'markdown') {
        const prefix = document.getElementById('mediaType').value === 'video' ? '![]' : '[]';
        document.getElementById('markdown-editor').value += `\n${prefix}(${mediaValue})`;
    } else {
        const tag = document.getElementById('mediaType').value === 'video' ? 
            `<video controls src="${mediaValue}"></video>` : 
            `<img src="${mediaValue}" class="uploaded-media">`;
        document.execCommand('insertHTML', false, tag);
    }

    bootstrap.Modal.getInstance(document.getElementById('mediaModal')).hide();
});

// HTMLæ¨¡å¼åˆ‡æ¢
document.getElementById('html-mode-toggle').addEventListener('click', function() {
    this.classList.toggle('active');
    const allowHtml = this.classList.contains('active') ? 1 : 0;
    document.getElementById('allowHtml').value = allowHtml;
    
    if (allowHtml) {
        alert('è­¦å‘Šï¼šå¯ç”¨HTMLæ¨¡å¼å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©ï¼');
    }
});
    </script>
</body>
</html>

